name: Go Patch Coverage (Presubmit)

on:
  pull_request:

jobs:
  patch-coverage:
    name: Patch Coverage
    runs-on: ubuntu-latest

    # ‚ùó Fail the check but DO NOT block merge
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # required for diff

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install tools
        run: |
          python3 -m pip install --upgrade pip
          pip install diff-cover
          go install github.com/reviewdog/reviewdog/cmd/reviewdog@latest

      - name: Generate patch coverage report
        run: |
          diff-cover coverage.out \
            --compare-branch origin/main \
            --fail-under 100 \
            --json-report diff-cover.json \
            --html-report diff-cover.html

      - name: Annotate uncovered lines in PR
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          reviewdog -f=diff-cover \
            -name="Go Patch Coverage" \
            -reporter=github-pr-check \
            -level=error < diff-cover.json

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: patch-coverage-report
          path: diff-cover.html
