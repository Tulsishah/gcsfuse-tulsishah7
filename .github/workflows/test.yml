name: Go Test & Coverage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # REQUIRED for Codecov to detect changes

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      # ... (Your "Run Tests" step here) ...
      - name: Run Tests on Changed Packages Only
        run: |
          # (Paste the script I gave you in the previous response here)
          # Make sure to include the generation of coverage.out
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
          else
            BASE_REF="origin/master"
          fi
          CHANGED_PKGS=$(git diff --name-only $BASE_REF | grep '\.go$' | xargs -r -L1 dirname | sort -u | sed 's|^|./|')
          if [ -z "$CHANGED_PKGS" ]; then
             echo "mode: set" > coverage.out
             exit 0
          fi
          go test -v -coverprofile=coverage.out $CHANGED_PKGS

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # <--- THIS IS REQUIRED NOW
          file: ./coverage.out
          fail_ci_if_error: true